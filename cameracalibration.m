X = [ 
      75.1267   25.5095   50.5957
   69.9077   89.0903   95.9291
   54.7216   13.8624   14.9294
   25.7508   84.0717   25.4282
   81.4285   24.3525   92.9264
   34.9984   19.6595   25.1084
   61.6045   47.3289   35.1660
   83.0829   58.5264   54.9724
   91.7194   28.5839   75.7200
   75.3729   38.0446   56.7822
    7.5854    5.3950   53.0798
   77.9167   93.4011   12.9906
   56.8824   46.9391    1.1902
   33.7123   16.2182   79.4285
   31.1215   52.8533   16.5649
   60.1982   26.2971   65.4079
   68.9215   74.8152   45.0542
    8.3821   22.8977   91.3337
   15.2378   82.5817   53.8342
   99.6135    7.8176   44.2678 ];
x = 1.0e+04 * [ 
    0.0847    0.0129
    0.0245    0.0035
    0.1846    0.0405
    0.0191    0.0064
    0.0646    0.0020
    0.0638    0.0092
    0.0450    0.0109
    0.0431    0.0100
    0.0782    0.0086
    0.0572    0.0093
    0.0461   -0.0049
    0.0287    0.0142
    0.0533    0.0211
    0.0451   -0.0032
    0.0302    0.0087
    0.0567    0.0040
    0.0307    0.0089
    0.0293   -0.0050
    0.0176    0.0029
   -1.2160   -0.2156 ];

% exact soltion
%{
R = [ 
    0.7472    0.0401    0.6634
    0.5417    0.5417   -0.6428
   -0.3851    0.8396    0.3830 ];
T= [ 120
    10
    13];
alpha = 1;
f = 100;

K=[ f 0 0;
    0 f 0;
    0 0 1];
	
	
% A v = 0  solve it with SVD
% x => x(*,1)
% y => x(*,2) etc.
% A = [	x*X x*Y x*Z x -y*X -y*Y -y*Y -y ];

%A= [ x(:,1).* X(:,1)   x(:,1).* X(:,2)   x(:,3).* X(:,1)   x(:,1)   x(:,2).* X(:,1)   x(:,2).* X(:,2)   x(:,2).* X(:,3)  x(:,2) ];

%}

P = X

p = x;
x = p(:,1);
y = p(:,2);
X = P(:,1);
Y = P(:,2);
Z = P(:,3);

A= [x.*X x.*Y x.*Z x -y.*X -y.*Y -y.*Z -y];
[U D Vt] = svd(A);
v = Vt(:,end);
gamma = norm(v(1:3)),
alpha = norm(v(5:7))/gamma;
vp = v/gamma;
Tx = vp(8);
Ty = vp(4);
alpha = norm(vp(5:7));
r1 = vp(5:7);
r2 = vp(1:3);
r3 = cross(r1,r2);

if dot(x,r1(1).*X+r1(2).*Y+r1(3).*Z+Tx) > 0
    r1 = -r1
    Tx = -Tx
end

if dot(x,r2(1).*X+r2(2).*Y+r2(3).*Z+Ty) > 0
    r2 = -r2
    Ty = -Ty
end

R = [r1 r2 r3];
R = R.';


A= [x r1(1).*X+r1(2).*Y+r1(3).*Z+Tx];
B= [-x.*(r3(1).*X+r3(2).*Y+r3(3).*Z+Tx)];
M = (A.'*A)^(-1)*A.'*B;
f = M(2);
Tz = M(1);
T = [Tx Ty Tz];

T = T.';
K = [f 0 0; 0 f 0; 0 0 1];

out = [p ones(size(p,1),1)];

pprime = out(1:3,:);
pprime

Pprime = P(1:3,:);

K = linsolve((R.*Pprime)+T,pprime);

R
T
alpha
f
K
